name: Release Build

on:
  push:
    tags:
      - 'v*.*.*'  # è§¦å‘æ¡ä»¶ï¼šæ¨é€ç‰ˆæœ¬æ ‡ç­¾ï¼Œå¦‚ v1.0.0
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘

permissions:
  contents: write  # å…è®¸å†™å…¥å†…å®¹
  id-token: write  # å…è®¸å†™å…¥IDä»¤ç‰Œ
  actions: read  # å…è®¸è¯»å–Actions

jobs:
  build-and-release:
    runs-on: windows-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Java
      uses: actions/setup-java@v4
      with:
        distribution: 'zulu'
        java-version: '17'
        
    - name: Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: '3.32.4'
        channel: 'stable'
        
    - name: Install Flutter dependencies
      run: flutter pub get
      
    - name: Enable Windows desktop
      run: flutter config --enable-windows-desktop
      
    - name: Build Windows executable
      run: flutter build windows --release
      
    - name: Build Android APK
      run: flutter build apk --release --split-per-abi
      
    - name: Get version from pubspec.yaml
      id: version
      run: |
        $version = (Select-String -Path "pubspec.yaml" -Pattern "^version: (.+)$").Matches[0].Groups[1].Value
        echo "VERSION=$version" >> $env:GITHUB_OUTPUT
      shell: powershell
      
    - name: Create Release Archive
      run: |
        # åˆ›å»ºWindowså¯æ‰§è¡Œæ–‡ä»¶å‹ç¼©åŒ…
        Compress-Archive -Path "build\windows\x64\runner\Release\*" -DestinationPath "spring_festival_couplet_generator-windows-x64.zip"
        
        # é‡å‘½åAPKæ–‡ä»¶ä¸ºæ›´å‹å¥½çš„åç§°
        Copy-Item "build\app\outputs\flutter-apk\app-arm64-v8a-release.apk" "spring_festival_couplet_generator-arm64-v8a.apk" -ErrorAction SilentlyContinue
        Copy-Item "build\app\outputs\flutter-apk\app-armeabi-v7a-release.apk" "spring_festival_couplet_generator-armeabi-v7a.apk" -ErrorAction SilentlyContinue
        Copy-Item "build\app\outputs\flutter-apk\app-x86_64-release.apk" "spring_festival_couplet_generator-x86_64.apk" -ErrorAction SilentlyContinue
      shell: powershell
      
    - name: Create Release
      uses: softprops/action-gh-release@v2
      with:
        tag_name: ${{ github.ref_name }}
        name: Release ${{ github.ref_name }}
        draft: false
        prerelease: false
        generate_release_notes: true
        files: |
          spring_festival_couplet_generator-windows-x64.zip
          spring_festival_couplet_generator-arm64-v8a.apk
          spring_festival_couplet_generator-armeabi-v7a.apk
          spring_festival_couplet_generator-x86_64.apk
        body: |
          ## ğŸ“± ä¸‹è½½è¯´æ˜

          ### Windows ç‰ˆæœ¬
          - **spring_festival_couplet_generator-windows-x64.zip**: Windows 64ä½å¯æ‰§è¡Œç¨‹åº

          ### Android ç‰ˆæœ¬
          - **spring_festival_couplet_generator-arm64-v8a.apk**: é€‚ç”¨äºç°ä»£Androidè®¾å¤‡ï¼ˆæ¨èï¼‰
          - **spring_festival_couplet_generator-armeabi-v7a.apk**: é€‚ç”¨äºè¾ƒè€çš„Androidè®¾å¤‡
          - **spring_festival_couplet_generator-x86_64.apk**: é€‚ç”¨äºx86æ¶æ„çš„Androidè®¾å¤‡

          ### å®‰è£…è¯´æ˜
          1. **Windows**: ä¸‹è½½zipæ–‡ä»¶ï¼Œè§£å‹åè¿è¡Œexeæ–‡ä»¶
          2. **Android**: ä¸‹è½½å¯¹åº”æ¶æ„çš„APKæ–‡ä»¶ï¼Œå…è®¸æœªçŸ¥æ¥æºå®‰è£…åç›´æ¥å®‰è£…

          ---
          *è‡ªåŠ¨æ„å»ºäº ${{ github.event.head_commit.timestamp }}*
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # å¯é€‰ï¼šæ·»åŠ å¤šå¹³å°æ„å»ºæ”¯æŒ
  build-linux:
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_dispatch'  # ä»…æ‰‹åŠ¨è§¦å‘æ—¶æ„å»ºLinuxç‰ˆæœ¬
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: '3.32.4'
        channel: 'stable'
        
    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y clang cmake ninja-build pkg-config libgtk-3-dev
        
    - name: Install Flutter dependencies
      run: flutter pub get
      
    - name: Enable Linux desktop
      run: flutter config --enable-linux-desktop
      
    - name: Build Linux executable
      run: flutter build linux --release
      
    - name: Create Linux Archive
      run: |
        tar -czf spring_festival_couplet_generator-linux-x64.tar.gz -C build/linux/x64/release/bundle .
      
    - name: Upload Linux Build
      uses: actions/upload-artifact@v4
      with:
        name: linux-build
        path: spring_festival_couplet_generator-linux-x64.tar.gz
